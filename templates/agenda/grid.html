{% extends 'base/go3base.html' %}
{% load i18n %}
{% load static %}
{% csrf_token %}


{% block headcontent %}
<link rel="stylesheet" href="{% static 'heatmap/jquery.CalendarHeatmap.min.css' %}">
{% endblock headcontent %}

{% block title %}{% trans "Grid"%}{% endblock title %}

{% block content %}
    <div class="row">
        <div class="page-header page-header mx-auto col-md-10 col-12">
            {% trans "Grid of Gigs" %}
            {% if user.preferences.default_view != 1 %}
            <span id='default-sel'>
                <small>(<a hx-get="{% url 'set-default-view' val=1 %}" hx-target='#default-sel' href="#">{% trans "Make this my default view!" %}</a>)</small>
            </span>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div id="hm" class="mx-auto col-md-10 col-12">
            <div>
                <button class='btn' onclick=yearClick(-1);><i class="fas fa-minus-square"></i></button>
                </button><span id='year-display'></span>
                <button class='btn' onclick=yearClick(1);><i class="fas fa-plus-square"></i></button>
            </div>
            <div id='heatmap-parent'>

            </div>
        </div>
    </div>
    <div class="row">
        <div id="gg" class="mx-auto col-md-10 col-12">
            <div>
                <button class='btn' onclick=monthClick(-1);><i class="fas fa-minus-square"></i></button>
                </button><span id='month-display'></span>
                <button class='btn' onclick=monthClick(1);><i class="fas fa-plus-square"></i></button>
            </div>
            <div id='giggrid-parent'>

            </div>
        </div>
    </div>
{% endblock content %}

{% block localscripts %}
{% comment %} https://github.com/SeBassTian23/CalendarHeatmap {% endcomment %}
<script src="{% static 'heatmap/jquery.CalendarHeatmap.min.js'%}"></script>
<script>

var data = [];
var year = {{year}};
var month = {{month}};

function monthClick(delta) {
    month = month + delta;

    if (month < 0) {
        month = 11;
        year -= 1;
        updateHeatMap();
    } else if (month > 11) {
        month = 0;
        year += 1;
        updateHeatMap();
    }

    updateGigGrid();
}

function updateGigGrid() {
    $('#month-display').html(moment().month(month).format('MMMM'))

}

function yearClick(delta) {
    year = year + delta;
    updateHeatMap();

    // new year = new month
    month = 0;
    updateGigGrid();
}

function updateHeatMap() {
    $.ajax({
        url: '{% url "grid-heatmap" %}',
        data: { 'year': JSON.stringify(year) },
        type: 'post',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(result) {
            data = JSON.parse(result);
            $('#year-display').html(year)
            $('#heatmap-parent').html('<div id="heatmap-location"></div>')
            $('#heatmap-location').CalendarHeatmap( data, {
                lastYear: year,
            } );
            // for each month, add a handler to update the list of gigs on display
            $('.ch-month').each(function(i, obj) {
                obj.addEventListener( "click", function() { handleMonthClick(i); } );
            });

        }
    })
}

$(document).ready(function() {
    updateHeatMap();
    updateGigGrid();
});

</script>
{% endblock localscripts %}

